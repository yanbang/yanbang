<template>
    <div class="container">
        <div id="markWater">
            <canvas id="water_mark" width="500" height="200"></canvas>
        </div>
        <!-- 页头 -->
        <Header>
            <template v-slot:smallTitle>
                <div class="header-smallTitle">评价-质</div>
            </template>
        </Header>
        <!-- 内容 -->
        <FlexBox :list="bottomList">
            <template slot>
                <div class="detailCon">
                    <div class="back" @click="toBack"><<< {{childRowData.eparchyName || '全省'}}</div>
                    <div class="date"><span>周日期：</span>{{date[0]}}~{{date[1]}}</div>
                    <!-- 左边 -->
                    <div class="left">
                        <div class="left-title">{{data.title}}</div>
                        <div class="top-content">
                            <div class="top-title">{{data.leftTitle1}}</div>
                            <div v-if="rowData.type == 1" class="top-center">
                                <div class="img">
                                    <img width="114" height="99" src="~@/assets/images/bigScreen/evaluate/icon_chart.png" />
                                </div>
                                <div class="text">
                                    <div>
                                        <span class="color">本周{{childRowData ? childRowData.areaName : `${rowData.eparchyName}市` }}移网新发展用户量</span>
                                        <span class="fontSize"><span>{{(result.newWeekCnt/10000).toFixed(2)  || '-'}}</span> 万户</span>
                                    </div>
                                    <div>
                                        <span class="color">本周{{childRowData ? childRowData.areaName : `${rowData.eparchyName}市` }}单宽转融用户不活跃度</span>
                                        <span class="fontSize"><span>{{result.newWeekYcGt0Rate || '-'}}</span> %</span>
                                    </div>
                                    <div>
                                        <span class="color">本周{{childRowData ? childRowData.areaName : `${rowData.eparchyName}市` }}单宽转融用户不活跃度</span>
                                        <span class="fontSize"><span>{{result.newWeekYcGt50Rate || '-'}}</span> %</span>
                                    </div>
                                </div>
                            </div>
                            <div v-if="rowData.type == 2" class="top-center padding">
                                <div class="img">
                                    <img width="114" height="99" src="~@/assets/images/bigScreen/evaluate/icon_chart.png" />
                                </div>
                                <div class="text">
                                    <div class="color">本周{{childRowData ? childRowData.areaName : `${rowData.eparchyName}市` }}8元卡发展在移网发展中占比</div>
                                    <div class="fontSize"><span>{{result.newWeek8yRate || '-'}}</span> %</div>
                                </div>
                            </div>
                            <div v-if="rowData.type == 3" class="top-center padding">
                                <div class="img">
                                    <img width="114" height="99" src="~@/assets/images/bigScreen/evaluate/icon_phone.png" />
                                </div>
                                <div class="text">
                                    <div class="color">本周{{childRowData ? childRowData.areaName : `${rowData.eparchyName}市` }}单宽转融用户不活跃度</div>
                                    <div class="fontSize"><span>{{result.weekDkzrBhyRate || '-'}}</span> %</div>
                                </div>
                            </div>
                        </div>
                        <div class="top-content">
                            <div class="top-title">{{data.leftTitle2}}</div>
                            <div :class="['top-center', {'padding': rowData.type != 1}]">
                                <div class="img">
                                    <!-- <img width="114" height="99" src="~@/assets/images/bigScreen/fullService/pingjia_jiaohao.png" /> -->
                                    <img width="114" height="99" src="~@/assets/images/bigScreen/fullService/pingjia_bad.png" />
                                </div>
                                <div class="text">
                                    <div v-for="(i, index) in tableData" :key="index">
                                        <span v-if="i.weekDkzrBhyRate_status == 2">
                                            {{childRowData ? i.gridName : i.areaName}}
                                        </span>
                                        <span v-if="i.newWeek8yRate_status == 2">
                                            {{childRowData ? i.gridName : i.areaName}}
                                        </span>
                                        <span v-if="i.newWeekYcGt0Rate_status == 2">
                                            {{childRowData ? i.gridName : i.areaName}}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 右边 -->
                    <div class="right">
                        <div class="right-title">{{childRowData ? childRowData.areaName : rowData.eparchyName || '各地'}}市详细情况</div>
                        <div v-if="rowData.type == 1" class="table">
                            <el-table :data="tableData" @sort-change='tableSortChange'>
                                <el-table-column prop="eparchyName" label="地区">
                                    <template slot-scope="scope">
                                        <span v-if="!userInfo.areaCode">
                                            <span v-if="scope.$index == 0 || childRowData">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                        <span v-else>
                                            <span v-if="scope.row.areaCode != userInfo.areaCode">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="newWeekCnt" label="移网新发展" sortable='1'></el-table-column>
                                <el-table-column prop="newWeekWyc" label="无预存" sortable ='2'></el-table-column>
                                <el-table-column prop="newWeekYcGt50" label="预存50元以上" sortable ='3'></el-table-column>
                                <el-table-column prop="newWeekYcGt50Rate" label="首次预存占比" sortable='4'>
                                    <template slot-scope="scope">
                                        <span v-if="scope.row.newWeekYcGt0Rate_status == 1" style="color: #00B050 !important">
                                            {{scope.row.newWeekYcGt50Rate}}%
                                        </span>
                                        <span v-else-if="scope.row.newWeekYcGt0Rate_status == 2" style="color: #C00000 !important">
                                            {{scope.row.newWeekYcGt50Rate}}%
                                        </span>
                                        <span v-else>{{scope.row.newWeekYcGt50Rate || '-'}}%</span>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                        <div v-if="rowData.type == 2" class="table">
                            <el-table :data="tableData" @sort-change='tableSortChange'>
                                <el-table-column prop="eparchyName" label="地区">
                                    <template slot-scope="scope">
                                        <span v-if="!userInfo.areaCode">
                                            <span v-if="scope.$index == 0 || childRowData">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                        <span v-else>
                                            <span v-if="scope.row.areaCode != userInfo.areaCode">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="newWeekCnt" label="移网新发展" sortable='1'></el-table-column>
                                <el-table-column prop="newWeek8y" label="8元卡发展量" sortable ='2'></el-table-column>
                                <el-table-column prop="newWeek8yRate" label="8元卡发展占比" sortable='3'>
                                    <template slot-scope="scope">
                                        <span v-if="scope.row.newWeek8yRate_status == 1" style="color: #00B050 !important">
                                            {{scope.row.newWeek8yRate}}%
                                        </span>
                                        <span v-else-if="scope.row.newWeek8yRate_status == 2" style="color: #C00000 !important">
                                            {{scope.row.newWeek8yRate}}%
                                        </span>
                                        <span v-else>{{scope.row.newWeek8yRate || '-'}}%</span>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                        <div v-if="rowData.type == 3" class="table">
                            <el-table :data="tableData" @sort-change='tableSortChange'>
                                <el-table-column prop="areaName" label="地区">
                                    <template slot-scope="scope">
                                        <span v-if="!userInfo.areaCode">
                                            <span v-if="scope.$index == 0 || childRowData">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                        <span v-else>
                                            <span v-if="scope.row.areaCode != userInfo.areaCode">
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                            <span v-else style="cursor:pointer" @click="clickTable(scope.row)" >
                                                {{childRowData ? scope.row.gridName : scope.row.areaName}}
                                            </span>
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="weekDkzrNum" label="单宽转融手机用户" sortable='1'></el-table-column>
                                <el-table-column prop="weekDkzrBhy" label="不活跃手机用户" sortable ='2'></el-table-column>
                                <el-table-column prop="weekDkzrBhyRate" label="不活跃用户占比" sortable='3'>
                                    <template slot-scope="scope">
                                        <span v-if="scope.row.weekDkzrBhyRate_status == 1" style="color: #00B050 !important">
                                            {{scope.row.weekDkzrBhyRate}}%
                                        </span>
                                        <span v-else-if="scope.row.weekDkzrBhyRate_status == 2" style="color: #C00000 !important">
                                            {{scope.row.weekDkzrBhyRate}}%
                                        </span>
                                        <span v-else>{{scope.row.weekDkzrBhyRate || '-'}}%</span>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </div>
                </div>
            </template>
        </FlexBox>
    </div>
</template>

<script>
import store from 'store'
import Header from '@/components/BigScreen/Header'
import FlexBox from '@/components/BigScreen/FlexBox'
import { dkzrhyd, xfz8yk, xfzyhscyc } from '@/api/z-evaluate.js'

export default {
  components: {
    Header,
    FlexBox
  },
  data() {
      return {
        param: {
            timest: '',
            areaCode: '',
            eparchyCode: '',
            gridId: ''
        },
        date: [],
        bottomList: [{
            name: '新发展用户套餐分档',
            url: '/mass/index',
        }, {
            name: '新发展用户三无',
            url: '/mass/massAdvanceDeposit',
        }, {
            name: '存量用户三无',
            url: '/mass/newmass',
        },{
            name: '新发展用户首次预存',
            url: '/bigscreen/evaluateNewUser',
        }, {
            name: '新发展8元卡',
            url: '/bigscreen/evaluateNew8Card',
        }, {
            name: '单宽转融活跃度',
            url: '/bigscreen/evaluateActivity',
        }],
        data: {
            title: '',
            leftTitle1: '',
            leftTitle2: '',
        },
        result: [],
        tableData: [],
        rowData: [],
        childRowData: '',
      }
  },
  created() {
  },
  mounted() {
    this.userInfo = store.get('userInfo');
    if (this.userInfo.isAddMask == '1') {
        this.$watermark(this.userInfo.serialNumber);
    } else {
        this.$watermark("");
    }
  },
  methods: {
    getDate(date) {
        this.rowData = this.$route.query.rowData
        this.rowData.areaCode = ''
        let childRowData = this.childRowData || ''
        this.param = {
            timest: date,
            eparchyCode: this.rowData.eparchyCode || '',
            areaCode: childRowData ? childRowData.areaCode : this.rowData.areaCode,
        }
        let today = date.split('-').join('')
        let y = today.substring(0,4)
        let m = today.substring(4,6)
        let d = today.substring(6)
        let weekEnd = y + '-' + m + '-' + d
        this.date = [this.getBeforeDate(6, weekEnd), this.getBeforeDate(0, weekEnd)]
        this.init()
    },
    toBack() {
        if(this.childRowData){
            this.param = {
                timest: this.param.timest,
                eparchyCode: this.rowData.eparchyCode || '',
                areaCode: '',
            }
            this.childRowData = ''
            this.init()
        } else {
            this.$router.go(-1)
        }
    },
    getBeforeDate(num, time) {
      let n = num;
      let d = '';
      if(time) {
        d = new Date(time);
      } else {
        d = new Date();
      }
      let year = d.getFullYear();
      let mon = d.getMonth() + 1;
      let day = d.getDate();
      if(day <= n) {
        if(mon > 1) {
          mon = mon - 1;
        } else {
          year = year - 1;
          mon = 12;
        }
      }
      d.setDate(d.getDate() - n);
      year = d.getFullYear();
      mon = d.getMonth() + 1;
      day = d.getDate();
      let s = year + "-" + (mon < 10 ? ('0' + mon) : mon) + "-" + (day < 10 ? ('0' + day) : day);
      return s;
    },
    init () {
        const rowData = this.rowData
        let index = index
        if(rowData.type == 1){
            index = 3
            this.initNewUser()
        }
        if(rowData.type == 2){
            index = 4
            this.initNew8Card()
        }
        if(rowData.type == 3){
            index = 5
            this.initActivity()
        }
        this.bottomList[index].active = true
    },
    // 新发展用户首次预存 初始化
    initNewUser() {
        const rowData = this.rowData
        const childRowData = this.childRowData
        let that = this
        xfzyhscyc(that.param).then(res => {
            if (res.rspCode === '0000') {
                let result = res.result || ''
                that.result = result.summaryJson
                that.tableData = result.listRes
            }
        })
        this.data = {
            title: `${childRowData ? childRowData.areaName : rowData.eparchyName}本周移网新发展用户首次预存质态` || '全省本周移网新发展用户首次预存质态',
            leftTitle1: '移网新发展用户首次预存占比情况',
            leftTitle2: '首次预存占比较高地市',
        }
    },
    // 新发展8元卡 初始化
    initNew8Card() {
        const rowData = this.rowData
        const childRowData = this.childRowData
        let that = this
        xfz8yk(that.param).then(res => {
            if (res.rspCode === '0000') {
                let result = res.result || ''
                that.result = result.summaryJson
                that.tableData = result.listRes
            }
        })
        this.data = {
            title: `${childRowData ? childRowData.areaName : rowData.eparchyName}本周8元卡发展质态` || '全省本周8元卡发展质态',
            leftTitle1: '新发展8元卡占比情况',
            leftTitle2: '新发展8元卡占比较高区县',
        }
    },
    // 单宽转融活跃度 初始化
    initActivity() {
        const rowData = this.rowData
        const childRowData = this.childRowData
        let that = this
        dkzrhyd(that.param).then(res => {
            if (res.rspCode === '0000') {
                let result = res.result || ''
                that.result = result.summaryJson
                that.tableData = result.listRes
            }
        })
        this.data = {
            title: `${childRowData ? childRowData.areaName : rowData.eparchyName}本周单宽转融发展质态` || '全省本周单宽转融发展质态',
            leftTitle1: '单宽转融不活跃度',
            leftTitle2: '不活跃用户占比较高区县',
        }
    }, 
    clickTable(row) {
        this.childRowData = row
        this.param = {
            timest: this.param.timest,
            eparchyCode: this.childRowData.eparchyCode || '',
            areaCode: this.childRowData.areaCode || '',
        }
        this.init()
    },
    //监听顺序方法
    tableSortChange(column) {
      const self = this
      let index = 0
      let tmpList = []
      this.allData = this.tableData[0]
      let string = column.prop
      this.tableData.forEach(obj => {
        if (index !== 0) {
          obj[string] = parseFloat(obj[string])
          tmpList.push(obj)
        }
        index = index + 1
      })
      if (column.order === 'descending') {
        this.sortA(tmpList, column.prop)
      } else {
        this.sortB(tmpList, column.prop)
      }

      this.tableData.unshift(this.allData)
    },
    sortA(arr, name) {
      //外层循环，控制趟数，每一次找到一个最大值
      for (var i = 0; i < arr.length - 1; i++) {
        // 内层循环,控制比较的次数，并且判断两个数的大小
        for (var j = 0; j < arr.length - 1 - i; j++) {
          // 白话解释：如果前面的数大，放到后面(当然是从小到大的冒泡排序)
          if (arr[j][name] > arr[j + 1][name]) {
            var temp = arr[j];
            arr[j] = arr[j + 1];
            arr[j + 1] = temp;
          }
        }

      }
      this.tableData = arr
    },
    sortB(arr, name) {
      //外层循环，控制趟数，每一次找到一个最大值
      for (var i = 0; i < arr.length - 1; i++) {
        // 内层循环,控制比较的次数，并且判断两个数的大小
        for (var j = 0; j < arr.length - 1 - i; j++) {
          // 白话解释：如果前面的数大，放到后面(当然是从小到大的冒泡排序)
          if (arr[j][name] < arr[j + 1][name]) {
            var temp = arr[j];
            arr[j] = arr[j + 1];
            arr[j + 1] = temp;
          }
        }
      }
      this.tableData = arr
    },
  }
}
</script>
<style lang="less" scoped>
    /deep/ .bottom{
        width: 82% !important;
        left: 9% !important;
    }
    .content {
        z-index: 100;
        height: 90%;
        background: url('~@/assets/images/bigScreen/bg-left-1.png') left no-repeat, 
        url('~@/assets/images/bigScreen/bg-right-1.png') right no-repeat;
        background-size: auto 100%;
    }
    /deep/ .el-table{
        background: none;
        font-family: Microsoft YaHei;
        font-weight: 400;
    }
    /deep/.el-table th{
        background: url("~@/assets/images/bigScreen/fullService/597bcdc505fa3.png") 50% 15px no-repeat;
        text-align: center;
        color: #02F6FF !important;
        font-size: 12px;
    }
    /deep/ .el-table tr{
        background: none !important;
    }
    /deep/.el-table td{
        background: none !important;
        border: none !important;
        text-align: center !important;
        color: #FFFFFF;
        font-family: DigifaceWide;
        font-size: 14px;
    }
    /deep/.el-table td:first-child {
        font-family: Microsoft YaHei;
        font-size: 18px;
    }
    /deep/ .el-table th.is-leaf, .el-table td{
        border: none !important;
        color: #FFFFFF ;
    }
    /deep/.el-table::before{
        height: 0 !important;
    }
    /deep/.el-table th > .cell{
        display: contents !important;
    }
    /deep/.el-table .ascending .sort-caret.ascending {
        border-bottom-color: #02f6ff;
    }

    /deep/.el-table .descending .sort-caret.descending {
        border-top-color: #02f6ff;
    }

    /deep/.el-dialog{
        width: 66%;
        background:transparent;
        background-image:url("~@/assets/images/bigScreen/kuang.png");
        background-size: 100% 100%;
        /*background-repeat:no-repeat ;*/
        /*background-size: cover;*/
        min-height:550px
    }
    /deep/.el-icon-close:before{

    content: none !important;
    }
    /deep/.el-dialog__headerbtn .el-dialog__close{
        width: 35px;
        height: 35px;
        background-image: url("~@/assets/images/bigScreen/close.png");
        background-repeat:no-repeat ;
        margin: 14px 30px;
    }
    /deep/.el-dialog__title{
        color: #02F6FF;
        font-size: 24px;
        width: 555px;
        font-size: 24px;
        font-family: PangMenZhengDao-3;
        font-weight: 400;
        background-image: url("~@/assets/images/bigScreen/fullService/biaoti.png");
        background-position: right;
        background-repeat: no-repeat;
        margin-left: 30px;
        display: block;
    }
    .container {
        z-index: 1;
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100%;
        color: #fff;
        background-image: image-set(url('~@/assets/images/bgImage.png') 1x);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        overflow: hidden;
        .header-smallTitle {
            font-size: 36px;
            font-family: MFBanHei;
            font-weight: 400;
            color: #ffffff;
            margin-top: -7px;
        }
    }
    .detailCon{
        display: flex;
        width: 100%;
        height: 90%;
        background-image: image-set(
            url('~@/assets/images/bigScreen/evaluate/left_bg.png') 1x,
            url('~@/assets/images/bigScreen/evaluate/left_bg.png') 2x
        );
        background-repeat: no-repeat;
        background-size: 100% 100%;
        margin-top: 20px;
        position: relative;
        padding-top: 50px;
        .back{
            position: absolute;
            top: 0;
            left: 130px;
            font-size: 14px;
            font-family: Microsoft YaHei;
            color: #02F6FF;
            cursor: pointer;
        }
        .date{
            position: absolute;
            top: 0;
            right: 130px;
            font-size: 12px;
            font-family: DigifaceWide;
            color: #fff;
            span{
                font-family: Microsoft YaHei;
                color: #02F6FF;
            }
        }
    }
    .left{
        width: 35%;
        height: 100%;
        padding-left: 30px;
        position: relative;
        .left-title{
            padding-right: 110px;
            font-size: 24px;
            font-family: MFBanHei;
            font-weight: 400;
            color: #02f6ff;
            display: inline-block;
            margin-bottom: 10px;
            background-image: image-set(
                url('~@/assets/images/bigScreen/fullService/Rectangle 561.png') 1x,
                url('~@/assets/images/bigScreen/fullService/Rectangle@2x.png') 2x
            );
            background-repeat: no-repeat;
            background-position: center right;
        }
        .top-content{
            width: 100%;
            height: 45%;
            padding: 20px 30px;
            margin-bottom: 1%;
            background-image: image-set(
                url('~@/assets/images/bigScreen/evaluate/kuang.png') 1x,
                url('~@/assets/images/bigScreen/evaluate/kuang@2x.png') 2x
            );
            background-repeat: no-repeat;
            background-size: 100% 100%;
        }
        .top-content:last-child{
            margin-bottom: 0;
        }
        .top-title{
            font-family: MFBanHei;
            color: #02F6FF; 
            font-size: 20px;
        }
        .top-center{
            display: flex;
            align-items: center;
            justify-content: center;
            height: calc(100% - 30px);
            .img{
                width: 150px;
                text-align: center;
            }
            .text{
                flex: 1;
                line-height: 30px;
                font-size: 17px;
                color: rgb(192, 0, 0);
                text-align: center;
            }
            .color{
                font-size: 14px;
                color: #02F6FF;
            }
            .fontSize{
                font-size: 14px;
                padding-left: 20px;
                color: #fff;
                span{
                    font-family: DigifaceWide;
                    font-size: 21px;
                        margin-right: 5px;
                }
            }
        }
        .padding{
            padding: 0 10%;
            text-align: center;
        }
        .left-chart{
            height: calc(100% - 250px);
        }
    }
    .right{
        flex: 1;
        height: 100%;
        padding: 0 20px;
        .right-title{
            width: 50%;
            height: 65px;
            line-height: 65px;
            padding: 0 30px;
            display: flex;
            justify-content: space-between;
            font-size: 26px;
            font-family: MFBanHei;
            font-weight: 400;
            background-image: image-set(
                url('~@/assets/images/bigScreen/fullService/title.png') 1x,
                url('~@/assets/images/bigScreen/fullService/title@2x.png') 2x
            );
            background-repeat: no-repeat;
            background-size: 100% 100%;
            color: #02f6ff;
        }
        .table{
            height: calc(100% - 85px);
        }
        .el-table{
            height: 100%;
            overflow: auto;
        }
    }
</style>